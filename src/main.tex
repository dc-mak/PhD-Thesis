\PassOptionsToPackage{outputdir=_build}{minted}
\PassOptionsToPackage{dvipsnames,usenames}{color}
% Load the kaobook class
\documentclass[
  french,english,
  fontsize=10pt, % Base font size
  twoside=true, % Use different layouts for even and odd pages (in particular, if twoside=true, the margin column will be always on the outside)
  %open=any, % If twoside=true, uncomment this to force new chapters to start on any page, not only on right (odd) pages
  secnumdepth=2, % How deep to number headings. Defaults to 1 (sections)
  numbers=enddot,
]{kaobook/kaobook}

% Choose the language
\usepackage{babel} % Load characters and hyphenation
\usepackage[english=british]{csquotes}	% English quotes

% Load packages for testing
\usepackage{blindtext}
\usepackage{comment}
%\usepackage{showframe} % Uncomment to show boxes around the text area, margin, header and footer
%\usepackage{showlabels} % Uncomment to output the content of \label commands to the document where they are used

% Load the bibliography package
\usepackage[style=alphabetic,maxbibnames=99,useprefix=true]{kaobook/kaobiblio}
\DefineBibliographyExtras{french}{\restorecommand\mkbibnamefamily} %To have consistent citations between French and English text
\addbibresource{biblio.bib} % Bibliography file

%Load my own style
\usepackage{styles/layout}

% Load mathematical packages for theorems and related environments
\usepackage[boxed]{kaobook/kaotheorems}

% Load the package for hyperreferences
\usepackage{kaobook/kaorefs}

% Macros are after the knowledge package
%TC:ignore
\input{knowledge_declarations.tex}
%TC:endignore
% \usepackage{styles/macros}
\usepackage{mathtools}
\usepackage{mathpartir}
\usepackage{stmaryrd}
\knowledgenewrobustcmd{\astRef}{\mathrel{\cmdkl{\ast}}}
\usepackage{styles/alectryon-minted}

\includeonly{header,intro,formal-intro,formal-kernel.gen,formal-statics.gen,formal-discussion,mem-model-intro,mem-model-cn,eng-intro,eng-usable,conclusion}
%\includeonly{formal-kernel.gen,formal-statics.gen,formal-discussion}

\graphicspath{{./figures/}} % Paths where images are looked for

% the un-wrapped (-tex_wrap false) generated LaTeX file for CN
%TC:ignore
\input{cn_included.gen}
% the package that allows customized layout described in this document
\usepackage{ott/ottlayout}
% the automatically generated file (with our Makefile) to link the generated
% LaTeX with the ottlayout package
\input{cn_override.gen}
\input{cn_drulenames.gen}
% Put judgement comment on a new line, half-BLS below the judgement form (in a box)
\renewenvironment{cndefnblock}[3][]{ \framebox{\mbox{#2}} \\[0.5\baselineskip] #3 \\[0pt]}{}
% Hide bind specs, and put comment on a new line underneath productions
\newcommand{\cnprodlineCommentNewline}[6]{& & $#1$ & $#2$ & $#3$ & $#5$ & \\ & & & \multicolumn{4}{p{\textwidth} }{#6} }
% Hide bind specs and put comment on same line
\renewcommand{\cnprodline}[6]{& & $#1$ & $#2$ & $#3$ & $#5$ & #6}
% Hide bind specs
\renewcommand{\cnbindspecprodline}[6]{}
\ottstyledefaults{numberpremises=yes,premisenamelayout=topright,rulelayout=nobreaks}
\ExplSyntaxOn%
% argument #1 calls \cnusedrule{\cmdX{}} with different \cmdX{}, and we want it
% to only have an effect if \cmdX{} is in the list #2.
\NewDocumentCommand{\onlyUseRules}{mm}
{
  \group_begin:%
  % split #2 on comma (clist = comma list) and put each element in a sequence
  \seq_clear:N \l_tmpa_seq
  \clist_map_inline:nn {#2}
  {
    \seq_gput_right:Nn \l_tmpa_seq {##1}
  }%

  %\typeout{Sequence}%
  %\seq_show:N \l_tmpa_seq {}%

  % save the original command
  \NewCommandCopy{\origcnusedrule}{\cnusedrule}%

  % intercept \cnusedrule to check if its argument is in the sequence,
  % and only call the original if so (otherwise do nothing)
  \renewcommand{\cnusedrule}[1]{%
    \seq_if_in:NnT \l_tmpa_seq {##1}
      {%
        %\typeout{Found!}
        \origcnusedrule{##1}%
      }%
  }
  #1
  \group_end:%
}
\ExplSyntaxOff%
%TC:endignore

%\makeindex[columns=3, title=Alphabetical Index, intoc] % Make LaTeX produce the files required to compile the index

\begin{document}

\include{header}

%----------------------------------------------------------------------------------------
%	MAIN BODY
%----------------------------------------------------------------------------------------

\mainmatter% Denotes the start of the main document content, resets page numbering and uses arabic numbers

\selectlanguage{english}

\include{intro}

\pagelayout{wide} % No margins
\addpart{Formalisation}%
\label{part:formalisation}
\pagelayout{margin} % Restore margins

\include{formal-intro}
\include{formal-kernel.gen}
\include{formal-statics.gen}
\include{formal-discussion}

\pagelayout{wide} % No margins
\addpart{Memory Object Model}%
\label{part:mem-model}
\pagelayout{margin} % Restore margins

\include{mem-model-intro}
\include{mem-model-cn}

\pagelayout{wide} % No margins
\addpart{Engineering}%
\label{part:engineering}
\pagelayout{margin} % Restore margins

\include{eng-intro}
\include{eng-usable}

\include{conclusion}

\appendix % From here onwards, chapters are numbered with letters, as is the appendix convention

\pagelayout{wide} % No margins
\addpart{Appendix}
\pagelayout{margin} % Restore margins

%TC:ignore
\include{appendix}
%TC:endignore

%----------------------------------------------------------------------------------------

\backmatter% Denotes the end of the main document content
\setchapterstyle{plain} % Output plain chapters from this point onwards

%----------------------------------------------------------------------------------------
%	BIBLIOGRAPHY
%----------------------------------------------------------------------------------------

% The bibliography needs to be compiled with biber using your LaTeX editor, or on the command line with 'biber main' from the template directory

\defbibnote{bibnote}{Here are the references in citation order.\par\bigskip} % Prepend this text to the bibliography
\printbibliography[heading=bibintoc, title=Bibliography, prenote=bibnote] % Add the bibliography heading to the ToC, set the title of the bibliography and output the bibliography note

%----------------------------------------------------------------------------------------
%	INDEX
%----------------------------------------------------------------------------------------

% The index needs to be compiled on the command line with 'makeindex main' from the template directory

% \printindex % Output the index

\newpage \mbox{}
\cleardoubleevenemptypage%
% \includepdf[pages=2]{../MathSTICTemplate/main.pdf}

\end{document}
